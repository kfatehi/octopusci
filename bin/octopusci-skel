#!/usr/bin/env ruby

$LOAD_PATH.unshift File.expand_path(File.dirname(__FILE__) + '/../lib')

require 'rubygems'
require 'octopusci/version'
require 'fileutils'
require 'trollop'

# if Process.uid != 0
#   puts "Must run as root"
#   exit 1
# end

opts = Trollop::options do
  version "Octopusci v#{Octopusci::Version} (c) Andrew De Ponte"
  banner """Usage: octopusci-skel [-n|-v|--version|-h|--help]"""
  opt :dry_run, "Don't actually do anything but describe what it would do", :short => "-n"
end

base_path = ENV['HOME'] + '/.octopusci'
jobs_path = base_path + '/jobs'
config_path = base_path + '/config.yml'
workspace_path = base_path + '/workspace'

config_default_content = """general:
  jobs_path: \"#{jobs_path}\"
  base_url: \"http://localhost:9998\"
  workspace_base_path: \"#{workspace_path}\"

http_basic:
  username: admin
  password: admin

smtp:
  notification_from_email: somefrom@example.com
  address: smtp.gmail.com
  port: 587
  authentication: plain
  enable_starttls_auto: true
  user_name: someuser@example.com
  password: somepassword
  raise_delivery_errors: true

projects:
  - { name: octopusci, owner: cyphactor, job_klass: SomeJobClass, repo_uri: 'git@github.com:cyphactor/octopusci.git', default_email: devs@example.com }

stages:
  - test_a
"""

if opts[:dry_run]
  puts "This is a Dry Run\n  No actions have been taken this is simply a description of what would normally take place.\n\n"
  puts "  1. mkdir -p #{jobs_path}"
  puts "  2. mkdir -p #{workspace_path}"
  puts "  2. Create example config (#{config_path}) if one doesn't exist"
else
  FileUtils.mkdir_p(jobs_path)
  FileUtils.mkdir_p(workspace_path)

  if !File.exists?(config_path)
    File.open(config_path, 'w') do |f|
      f << config_default_content
    end
    puts "Created example #{config_path}, please modify appropriately"
  else
    puts "#{config_path} already exists, exiting to avoid modification."
    puts "If you would like to generate the example config again please rename the existing #{config_path}."
  end
end
